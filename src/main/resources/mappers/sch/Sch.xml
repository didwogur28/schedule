<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Thu Jan 29 13:11:14 KST 2015-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.schedule.sch.dao.SchMapper">

    <!-- 해당 월 일정 관리 정보 조회 -->
    <select id="getCntInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select cpn_cd as "cpnCd"
              ,usr_id as "usrId"
              ,con_cd as "conCd"
              ,con_dtl as "conDtl"
              ,st_dt as "stDt"
              ,concat(substring(st_dt,1,4),'-',substring(st_dt,5,2),'-',substring(st_dt,7)) as "stFullDt"
              ,st_tm as "stTm"
              ,ed_dt as "edDt"
              ,ed_tm as "edTm"
          from sch.sch_cnt_ctrl
         where cpn_cd = #{cpnCd}
           and substring(st_dt,1 ,6) = #{date}
         order by st_dt
    </select>

    <!-- 해당 월 주별 Row 조회 -->
    <select id="getWeekRow" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select a.st_wk as "stWk"
              ,max(a.stMaxCnt) as "stMaxCnt"
          from (select st_wk, count(st_dt) stMaxCnt
                  from sch.sch_cnt_ctrl
                 where cpn_cd = #{cpnCd}
                   and substring(st_dt,1 ,6) = #{date}
                 group by st_wk, st_dt) a
         group by a.st_wk
    </select>

    <!-- 이번 달 일정 등록 -->
    <insert id="saveMonthCnt" parameterType="java.util.HashMap">
        with upsert as (
                        update sch.sch_cnt_ctrl
                           set con_dtl = #{content}
                              ,st_wk = #{stWk}
                              ,st_dt = replace(#{stDay}, '-','')
                              ,st_tm = coalesce(#{stTm}, #{allTm})
                              ,ed_wk = coalesce(#{edTm}, #{allTm})
                              ,ed_dt = replace(#{edDay}, '-','')
                              ,ed_tm = #{edTm}
                              ,stat_cd = 'CNT100'
                         where cpn_cd = #{cpnCd}
                           and usr_id = #{usrId}
                           and con_cd = #{conBox}
                     returning 1
        )
        insert into sch.sch_cnt_ctrl (
                                       cpn_cd
                                      ,usr_id
                                      ,con_cd
                                      ,con_dtl
                                      ,st_wk
                                      ,st_dt
                                      ,st_tm
                                      ,ed_wk
                                      ,ed_dt
                                      ,ed_tm
                                      ,stat_cd
        )
        select #{cpnCd}::varchar
              ,#{usrId}
              ,#{conBox}::varchar
              ,#{content}
              ,#{stWk}
              ,replace(#{stDay}, '-','')
              ,coalesce(#{stTm}, #{allTm})
              ,#{edWk}
              ,replace(#{edDay}, '-','')
              ,coalesce(#{edTm}, #{allTm})
              ,'CNT100'
         where not exists (select 1 from upsert)
    </insert>
</mapper>